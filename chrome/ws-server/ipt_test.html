<html>
<head>
  <title>IPT Test</title>
  <script src="uuid-random.min.js"></script>
  <script src="hybridge_key.js"></script>
  <script src="hybridge.js"></script>
  <script src="app_web.js"></script>
  <script src="utils.js"></script>
  <style>
    .tab {
    border-collapse: collapse;
    }
    .tab td, th {
    padding: 8px;
    }

    .tab td {
    border: 1px solid gray;
    }

    div#track {
    margin: 4px;
    padding: 4px;
    text-align: center;
    background-color: orange;
    }
  </style>
</head>
<body>
<div>
  <h1>IPT Test</h1>
  <table class="tab">
    <tr><th>ext-app linked</th>
      <td colspan=2 id="ext_app_linked"><div id="track">0</div></td>
      </tr>
    <tr><th>from hybridge</th>
      <td id="arg-a"></td>
      <td id="arg-b"></td>
    </tr>
    <tr>
      <th>to hybridge</th>
      <td><input type="text" id="to-hybridge-txt"></td>
      <td><button id="to-hybridge-btn" type="button">TO HYBRIDGE</button></td>
    </tr>
  </table>
  <div id="results">
  </div>
</div>
</body>
<script>
var app_web;

window.onload = function window_onload() {
    app_web = new AppWeb('ipt');

    document.getElementById("to-hybridge-btn").addEventListener(
        "click",
        function() {
            console.log('send msg');
            var arg = document.getElementById("to-hybridge-txt").value;
            var uu = app_web.send({'command': 'ext_app_open', 'args': [arg]},
                                  on_cmd_cb);
            console.log("FIRED CMD WITH UUID: " + uu);
        }
    );
    var time_cur = 0;
    var time_delta = 500;

    setTimeout(function(){
        var expected = {"content":null,"reason":"ok","ret":0};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'ext_app_open', 'args': ['Testing']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'clear_dir', 'args': []};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":true,"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'on_same_fs', 'args': []};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        // FIXME: instead of failing because of the missing zip file, it should run a calculation
        // FIXME: this would fail for a different user
        var expected = {"content":null,"reason":"[Errno 2] No such file or directory: '/home/paolo/.gem/irmt/ipt/ScenarioHazard.zip'","success":false};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'run_oq_engine_calc', 'args': [['ScenarioHazard.zip']]};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'save_str_to_file', 'args': ['this is the content', 'test.txt']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":"this is the content","reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'read_file', 'args': ['test.txt']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":["test.txt"],"reason":"ok","success":true}
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'ls', 'args': []};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'move_file', 'args': ['test.txt', 'test_renamed.txt']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);
    
    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":["test_renamed.txt"],"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'ls', 'args': []};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'delete_file', 'args': ['test_renamed.txt']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":[],"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'ls', 'args': []};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"No file was selected","success":false};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'select_and_copy_file_to_dir', 'args': ['.', false, 'Test file chooser title']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"No file was selected","success":false}
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'select_and_copy_file_to_dir', 'args': ['.', true]};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":[""],"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'select_file', 'args': ['.', false]};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":[],"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'select_file', 'args': ['.', true, 'Test title for select_file call']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'create_dir', 'args': ['test1/test2']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        // FIXME: the check on the expected return value should not consider '/home/paolo'
        var expected = {"content":null,"reason":"[Errno 17] File exists: '/home/paolo/.gem/irmt/ipt/test1'","success":false};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'create_dir', 'args': ['test1']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"Unable to create the directory ../test3","success":false};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        // this kind of attempt is supposed to be refused
        var cmd = {'command': 'create_dir', 'args': ['../test3']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'save_str_to_file', 'args': ['this is the content', 'test1/test2/test.txt']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":["test1/"],"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'ls', 'args': []};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":["test2/"],"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'ls', 'args': ['test1']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":["test.txt"],"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'ls', 'args': ['test1/test2']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'delete_dir', 'args': ['test1']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":[],"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'ls', 'args': []};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    //
    //   test build_zip
    //
    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'create_dir', 'args': ['zipdir1']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'save_str_to_file', 'args': ['this is the content', 'zipdir1/test.txt']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'create_dir', 'args': ['zipdir2']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":null,"reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'save_str_to_file', 'args': ['this is another content', 'zipdir2/another_test.txt']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);

    time_cur += time_delta;
    setTimeout(function(){
        var expected = {"content":"temp/test_archive.zip", "reason":"ok","success":true};
        function check_expected(uu, msg) {
            custom_on_cmd_cb(uu, msg, expected);
        }
        var cmd = {'command': 'build_zip', 'args': [
            [['file', 'test.txt', 'zipdir1/test.txt'],
             ['file', 'another_test.txt', 'zipdir2/another_test.txt'],
             ['string', 'string_test.txt', 'this content arrives from a string\nthis is on another line\n']],
            'test_archive.zip']};
        var uu = app_web.send(cmd, check_expected);
        custom_on_cmd_cb(uu, cmd);
    }, time_cur);


}
  </script>
</html>
